{
  "doc_type": "business_logic",
  "title": "부분취소(부분환불) 처리 프로세스",
  "content": "## 부분취소(부분환불) 처리 프로세스\n\n### 부분취소 가능 조건\n- 결제 상태가 **DONE**(결제 완료)인 경우에만 가능\n- 부분취소 누적 금액이 원래 결제 금액을 초과할 수 없음\n- 가상계좌 결제는 부분취소 불가 (전액취소만 가능)\n- 이미 전액취소(CANCELED) 상태인 결제는 부분취소 불가\n\n### 처리 흐름 (5단계)\n\n**1단계: 부분취소 요청 접수**\n- 가맹점이 API를 통해 부분취소 요청 (원래 paymentId + 취소 금액 전달)\n- 시스템이 결제 상태(DONE) 및 취소 가능 금액 검증\n\n**2단계: 취소 금액 검증**\n- 기존 부분취소 누적액 + 이번 취소 요청액 ≤ 원래 결제 금액 확인\n- 검증 실패 시 에러 반환 (REFUND_AMOUNT_EXCEEDED)\n\n**3단계: PG사 취소 요청**\n- 원래 결제에 사용된 PG사에 부분취소 요청 전달\n- PG사 응답 대기 (타임아웃: 30초)\n\n**4단계: 환불 레코드 생성**\n- refunds 테이블에 환불 레코드 생성 (refund_type: 'PARTIAL')\n- payment_history에 상태 변경 이력 기록\n- 결제 상태를 PARTIAL_CANCELED로 변경\n\n**5단계: 정산 반영**\n- balance_transactions에 마이너스 거래 기록\n- 다음 정산 주기에 환불 금액 차감 반영\n\n### 누적 부분취소 예시\n\n| 순서 | 동작 | 결제금액 | 누적취소액 | 잔여금액 | 결제상태 |\n|------|------|----------|-----------|----------|----------|\n| 1 | 결제 | 100,000원 | 0원 | 100,000원 | DONE |\n| 2 | 1차 부분취소 | 100,000원 | 30,000원 | 70,000원 | PARTIAL_CANCELED |\n| 3 | 2차 부분취소 | 100,000원 | 50,000원 | 50,000원 | PARTIAL_CANCELED |\n| 4 | 3차 전액취소 | 100,000원 | 100,000원 | 0원 | CANCELED |\n\n### 주의사항\n- 부분취소 후 잔여 금액이 0원이 되면 상태가 **CANCELED**로 변경됨\n- 부분취소 건별로 별도의 refund 레코드가 생성됨\n- 카드 결제의 경우 부분취소 후 매입 취소까지 1~3 영업일 소요\n- 간편결제(카카오페이, 네이버페이 등)는 PG사별 부분취소 지원 여부 확인 필요\n\n### 관련 에러코드\n- **REFUND_AMOUNT_EXCEEDED**: 취소 금액이 잔여 결제 금액을 초과\n- **INVALID_PAYMENT_STATUS**: 결제 상태가 취소 가능 상태가 아님\n- **PG_REFUND_FAILED**: PG사 취소 처리 실패\n- **VIRTUAL_ACCOUNT_PARTIAL_REFUND_NOT_SUPPORTED**: 가상계좌 부분취소 미지원",
  "metadata": {
    "domain": "payment",
    "process": "partial_refund",
    "related_entities": ["Payment", "Refund", "PaymentHistory", "BalanceTransaction"],
    "related_statuses": ["DONE", "PARTIAL_CANCELED", "CANCELED"],
    "related_error_codes": ["REFUND_AMOUNT_EXCEEDED", "INVALID_PAYMENT_STATUS", "PG_REFUND_FAILED", "VIRTUAL_ACCOUNT_PARTIAL_REFUND_NOT_SUPPORTED"]
  }
}
