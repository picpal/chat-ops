# Check-Point 014: WHERE 조건 컨텍스트 리셋 수정

**날짜:** 2026-01-17
**작업 유형:** Bug Fix
**상태:** ✅ 완료

---

## 문제 상황

### 증상
연속 대화 후 "새 쿼리"를 시작해도 이전 WHERE 조건이 계속 누적되는 버그

### 재현 시나리오
```
1. "최근 3개월 결제건"         → WHERE created_at >= '3 months'
2. "이중 mer_001 가맹점만"     → WHERE ... AND merchant_id = 'mer_001'
3. "이중에 도서관련 상품만"     → WHERE ... AND order_name LIKE '%도서%'
4. "최근 1개월 거래건" [새 쿼리] → 기대: WHERE '1 month' 만
                                   실제: WHERE '1 month' + mer_001 + 도서 (버그!)
5. "여기서 mer_008만"          → mer_001, 도서 조건까지 포함됨 (버그!)
```

### 근본 원인
- `text_to_sql.py`에서 LLM에게 누적된 WHERE 조건을 **"[필수 유지]"**로 전달
- LLM이 새 쿼리인지 꼬리질문인지 판단 없이 항상 이전 조건 포함

---

## 해결 방안

### 접근법: LLM 기반 의도 판단

기존 regex 패턴 대신 LLM이 "새 쿼리 vs 꼬리질문"을 판단하도록 프롬프트 수정

### 수정 파일

**파일:** `services/ai-orchestrator/app/services/text_to_sql.py`

#### 변경 1: `_build_prompt()` (799-822행)

SQL 생성 가이드에 의도 판단 지시 추가:

```python
## 1단계: 질문 유형 판단 (필수)
A) 새 쿼리 (new_query): 이전 조건 무시
   - "최근 N개월/일 조회" (새로운 시간 조건)
   - "새로", "다시", "처음부터" 등
   - "잊어버리고", "무시하고" 등

B) 꼬리질문 (refinement): 직전 쿼리 조건 유지
   - "이중에", "여기서", "그중에" 등
   - "~만", "~제외" 등
```

#### 변경 2: `_build_conversation_flow()` (865-876행)

```python
# 변경 전
"### [중요] 현재까지 누적된 모든 WHERE 조건 (필수 유지)"
"**위 조건들은 반드시 유지해야 합니다.**"

# 변경 후
"### [참고] 이전 대화에서 사용된 WHERE 조건"
"**위 조건 사용 여부는 질문 유형에 따라 결정하세요:**"
"- new_query: 위 조건 무시, 새로운 WHERE 절 작성"
"- refinement: 직전 쿼리의 조건만 유지 + 새 조건 추가"
```

---

## 테스트 결과

### TC-005: 컨텍스트 초기화 후 꼬리질문

| 단계 | 입력 | SQL WHERE 절 | 결과 |
|------|------|-------------|------|
| 1 | 최근 3개월 결제건 | `created_at >= '3 months'` | ✅ |
| 2 | 이중 mer_001만 | `... AND merchant_id = 'mer_001'` | ✅ |
| 3 | 이중에 도서관련 | `... AND order_name LIKE '%도서%'` | ✅ |
| 4 | 최근 1개월 거래건 | `created_at >= '1 month'` (리셋!) | ✅ |
| 5 | 여기서 mer_008만 | `'1 month' AND merchant_id = 'mer_008'` | ✅ |

**핵심 검증:** Step 5에서 mer_001, 도서 조건 없음 확인

### TC-003: WHERE 조건 체이닝 (회귀 테스트)

| 단계 | SQL WHERE 절 | 결과 |
|------|-------------|------|
| 1 | `created_at >= '3 months'` | ✅ |
| 2 | `... AND merchant_id = 'mer_001'` | ✅ |
| 3 | `... AND order_name LIKE '%도서%'` | ✅ |

**회귀 없음:** 연속 꼬리질문 시 조건 누적 정상 동작

---

## 학습 포인트

1. **LLM에게 강제 vs 권장**
   - "[필수]"는 LLM이 맹목적으로 따름
   - "[참고]" + 판단 기준 제공이 더 유연함

2. **의도 분류의 중요성**
   - 사용자 발화에서 "새 쿼리인지, 꼬리질문인지" 판단이 핵심
   - regex 패턴보다 LLM 기반 판단이 더 자연스러움

3. **"잊어버리고" 같은 표현**
   - 별도 패턴 추가 없이 LLM이 자연어로 이해 가능

---

## 관련 시나리오

- `test-scenarios/003-where-condition-chaining.md`
- `test-scenarios/005-context-reset-and-followup.md`

---

## 다음 단계

- [ ] "잊어버리고" 표현 추가 테스트
- [ ] 4단계+ 체이닝 후 새 쿼리 시나리오 추가 테스트
- [ ] UI에서 실제 대화로 검증
