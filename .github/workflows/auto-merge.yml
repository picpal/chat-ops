name: Auto Merge on Review Pass

on:
  pull_request_review:
    types: [submitted]
  check_suite:
    types: [completed]
  workflow_run:
    workflows: ["PR Code Review"]
    types: [completed]

permissions:
  contents: write
  pull-requests: write

jobs:
  auto-merge:
    runs-on: ubuntu-latest
    # Claude 또는 승인된 리뷰어가 approve한 경우
    if: |
      (github.event_name == 'pull_request_review' &&
       github.event.review.state == 'approved') ||
      (github.event_name == 'workflow_run' &&
       github.event.workflow_run.conclusion == 'success')
    steps:
      - name: Get PR number
        id: pr
        run: |
          if [ "${{ github.event_name }}" == "workflow_run" ]; then
            echo "number=${{ github.event.workflow_run.pull_requests[0].number }}" >> $GITHUB_OUTPUT
          else
            echo "number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          fi

      - name: Check if review passed
        id: check
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          if [ -z "$PR_NUMBER" ]; then
            echo "No PR number found"
            exit 0
          fi

          # PR 리뷰 상태 확인
          REVIEWS=$(gh pr view $PR_NUMBER --repo ${{ github.repository }} --json reviews -q '.reviews')
          APPROVED=$(echo "$REVIEWS" | jq '[.[] | select(.state == "APPROVED")] | length')

          if [ "$APPROVED" -gt "0" ]; then
            echo "approved=true" >> $GITHUB_OUTPUT
          else
            echo "approved=false" >> $GITHUB_OUTPUT
          fi

      - name: Enable auto-merge
        if: steps.check.outputs.approved == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          echo "Enabling auto-merge for PR #$PR_NUMBER"
          gh pr merge $PR_NUMBER --repo ${{ github.repository }} --auto --squash \
            --subject "chore: auto-merge PR #$PR_NUMBER" || echo "Auto-merge may already be enabled or PR is not mergeable"

      - name: Add merge label
        if: steps.check.outputs.approved == 'true'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ steps.pr.outputs.number }}
          gh pr edit $PR_NUMBER --repo ${{ github.repository }} --add-label "auto-merge" || true
