# Test Scenario 005: ì»¨í…ìŠ¤íŠ¸ ì´ˆê¸°í™” í›„ ê¼¬ë¦¬ ì§ˆë¬¸

**ì‘ì„±ì¼:** 2026-01-17
**ê¸°ëŠ¥:** ì—°ì† ì§ˆë¬¸ í›„ ìƒˆ ì¿¼ë¦¬ ì‹œì‘ ë° ê¼¬ë¦¬ ì§ˆë¬¸ ë™ì‘ ê²€ì¦
**ìƒíƒœ:** âœ… í…ŒìŠ¤íŠ¸ í†µê³¼

---

## 1. í…ŒìŠ¤íŠ¸ ëª©ì 

ì—¬ëŸ¬ ê¼¬ë¦¬ ì§ˆë¬¸ í›„ ìƒˆë¡œìš´ ì¿¼ë¦¬ë¥¼ ì‹œì‘í•˜ê³ , ë‹¤ì‹œ ê¼¬ë¦¬ ì§ˆë¬¸í•  ë•Œ ì˜¬ë°”ë¥´ê²Œ ë™ì‘í•˜ëŠ”ì§€ ê²€ì¦

### ë°°ê²½
- ì‚¬ìš©ìê°€ ì—¬ëŸ¬ ì§ˆë¬¸ì„ í•œ í›„ ìƒˆ ì£¼ì œë¡œ ì „í™˜
- ìƒˆ ì¿¼ë¦¬ í›„ ë‹¤ì‹œ ê¼¬ë¦¬ ì§ˆë¬¸ ì‹œ ì»¨í…ìŠ¤íŠ¸ê°€ ì˜¬ë°”ë¥´ê²Œ ì ìš©ë˜ì–´ì•¼ í•¨
- ì»¨í…ìŠ¤íŠ¸ ì—†ì´ ì§ˆë¬¸ ì‹œ ì˜ë„ì™€ ë‹¤ë¥¸ í…Œì´ë¸”ì´ ì¡°íšŒë  ìˆ˜ ìˆìŒ

---

## 2. ì‚¬ì „ ì¡°ê±´

- [ ] AI Orchestrator: http://localhost:8000 ì‹¤í–‰ ì¤‘
- [ ] Core API: http://localhost:8080 ì‹¤í–‰ ì¤‘
- [ ] PostgreSQL: í…ŒìŠ¤íŠ¸ ë°ì´í„° ì¡´ì¬

---

## 3. í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤

### TC-005-1: ìƒˆ ì¿¼ë¦¬ í›„ ê¼¬ë¦¬ ì§ˆë¬¸ (ì •ìƒ ì¼€ì´ìŠ¤)

**ìˆœì„œ:**
1. "ìµœê·¼ 1ê°œì›” ê±°ë˜ê±´ ì¡°íšŒí•´ì¤˜" (ìƒˆ ì¿¼ë¦¬)
2. "mer_008 ê°€ë§¹ì ë§Œ ì¡°íšŒí•´ì¤˜" (ê¼¬ë¦¬ ì§ˆë¬¸, conversationHistory í¬í•¨)

**ê¸°ëŒ€ ê²°ê³¼:**

| ë‹¨ê³„ | SQL WHERE ì ˆ | ê¸°ëŒ€ ê±´ìˆ˜ |
|------|-------------|----------|
| 1 | `created_at >= NOW() - INTERVAL '1 months'` | ~686ê±´ |
| 2 | `created_at >= ... AND merchant_id = 'mer_008'` | ~89ê±´ |

**ê²€ì¦ í¬ì¸íŠ¸:**
- Step 2ì—ì„œ payments í…Œì´ë¸” ì¡°íšŒ
- ì´ì „ ì‹œê°„ ì¡°ê±´(1ê°œì›”) ìœ ì§€
- merchant_id ì¡°ê±´ ì¶”ê°€

---

### TC-005-2: ì»¨í…ìŠ¤íŠ¸ ì—†ì´ ê°€ë§¹ì  ì¡°íšŒ (ì£¼ì˜ ì¼€ì´ìŠ¤)

**ì…ë ¥:**
```
mer_008 ê°€ë§¹ì ë§Œ ì¡°íšŒí•´ì¤˜
```
(conversationHistory ì—†ìŒ)

**ê¸°ëŒ€ ê²°ê³¼:**

| í•­ëª© | ê°’ |
|------|-----|
| ì¡°íšŒ í…Œì´ë¸” | merchants (payments ì•„ë‹˜!) |
| SQL | `SELECT * FROM merchants WHERE merchant_id = 'mer_008'` |
| ê±´ìˆ˜ | 1ê±´ (ê°€ë§¹ì  ì •ë³´) |

**ì£¼ì˜:** ì»¨í…ìŠ¤íŠ¸ ì—†ì´ "ê°€ë§¹ì ë§Œ ì¡°íšŒ"ëŠ” ê°€ë§¹ì  ë§ˆìŠ¤í„° ì •ë³´ë¥¼ ì¡°íšŒí•¨

---

### TC-005-3: ê¸´ ëŒ€í™” í›„ ìƒˆ ì¿¼ë¦¬ ì „í™˜

**ìˆœì„œ:**
1. "ìµœê·¼ 3ê°œì›” ê²°ì œê±´" â†’ 2. "ì´ì¤‘ mer_001ë§Œ" â†’ 3. "ê¸ˆì•¡ 100ë§Œì› ì´ìƒë§Œ"
4. "ìƒˆë¡œ ì¡°íšŒí•´ì¤˜, ìµœê·¼ 1ê°œì›” ê±°ë˜ê±´" (ëª…ì‹œì  ìƒˆ ì¿¼ë¦¬)
5. "mer_008 ê°€ë§¹ì ë§Œ" (ìƒˆ ì¿¼ë¦¬ ê¸°ì¤€ ê¼¬ë¦¬ ì§ˆë¬¸)

**ê¸°ëŒ€ ê²°ê³¼:**

| ë‹¨ê³„ | ì˜ˆìƒ ë™ì‘ |
|------|----------|
| 1-3 | WHERE ì¡°ê±´ ëˆ„ì  |
| 4 | ì´ì „ ì¡°ê±´ ë¬´ì‹œ, ìƒˆ ì¿¼ë¦¬ ì‹œì‘ |
| 5 | Step 4ì˜ 1ê°œì›” ì¡°ê±´ + mer_008 ì¡°ê±´ |

**ê²€ì¦ í¬ì¸íŠ¸:**
- Step 4ì—ì„œ "ìƒˆë¡œ"ë¡œ ì¸í•´ ì´ì „ ì¡°ê±´(3ê°œì›”, mer_001, 100ë§Œì›) ëª¨ë‘ ë¦¬ì…‹
- Step 5ëŠ” Step 4 ê¸°ì¤€ìœ¼ë¡œ ì¡°ê±´ ì¶”ê°€

---

## 4. API í…ŒìŠ¤íŠ¸ (curl)

### TC-005-1 ì‹¤í–‰

```bash
# Step 1: ìƒˆ ì¿¼ë¦¬
RESP1=$(curl -s -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "ìµœê·¼ 1ê°œì›” ê±°ë˜ê±´ ì¡°íšŒí•´ì¤˜"}')
echo "Step1: $(echo $RESP1 | jq '{sql: .queryPlan.sql, rows: .queryResult.metadata.totalRows}')"

# Step 2: ê¼¬ë¦¬ ì§ˆë¬¸ (conversationHistory í¬í•¨)
SQL1=$(echo $RESP1 | jq -r '.queryPlan.sql')
TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)
curl -s -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d "{
    \"message\": \"mer_008 ê°€ë§¹ì ë§Œ ì¡°íšŒí•´ì¤˜\",
    \"conversationHistory\": [
      {\"id\": \"1\", \"role\": \"user\", \"content\": \"ìµœê·¼ 1ê°œì›” ê±°ë˜ê±´ ì¡°íšŒí•´ì¤˜\", \"timestamp\": \"$TIMESTAMP\"},
      {\"id\": \"2\", \"role\": \"assistant\", \"content\": \"ê²°ê³¼\", \"timestamp\": \"$TIMESTAMP\",
       \"queryPlan\": {\"mode\": \"text_to_sql\", \"sql\": \"$SQL1\"}}
    ]
  }" | jq '{sql: .queryPlan.sql, rows: .queryResult.metadata.totalRows}'
```

### TC-005-2 ì‹¤í–‰ (ì»¨í…ìŠ¤íŠ¸ ì—†ìŒ)

```bash
curl -s -X POST http://localhost:8000/api/v1/chat \
  -H "Content-Type: application/json" \
  -d '{"message": "mer_008 ê°€ë§¹ì ë§Œ ì¡°íšŒí•´ì¤˜"}' | jq '{sql: .queryPlan.sql, rows: .queryResult.metadata.totalRows}'
```

---

## 5. ê²€ì¦ í¬ì¸íŠ¸ ìš”ì•½

| ì‹œë‚˜ë¦¬ì˜¤ | ê²€ì¦ í•„ë“œ | ê¸°ëŒ€ê°’ |
|---------|----------|--------|
| TC-005-1 Step1 | `.queryPlan.sql` | `FROM payments` í¬í•¨ |
| TC-005-1 Step2 | `.queryPlan.sql` | `merchant_id = 'mer_008'` AND ì‹œê°„ì¡°ê±´ í¬í•¨ |
| TC-005-2 | `.queryPlan.sql` | `FROM merchants` (payments ì•„ë‹˜) |
| TC-005-3 Step4 | `.queryPlan.sql` | ì´ì „ ì¡°ê±´ ì—†ìŒ, 1ê°œì›”ë§Œ |

---

## 6. ê´€ë ¨ ì½”ë“œ

| íŒŒì¼ | í•¨ìˆ˜/ìœ„ì¹˜ | ì—­í•  |
|------|----------|------|
| `chat.py` | `detect_reference_expression()` | "ì´ì¤‘", "ì—¬ê¸°ì„œ" ë“± ì°¸ì¡° ê°ì§€ |
| `chat.py` | `detect_new_query_intent()` | "ìƒˆë¡œ", "ë‹¤ì‹œ" ë“± ìƒˆ ì¿¼ë¦¬ ê°ì§€ |
| `text_to_sql.py` | `merge_where_conditions()` | WHERE ì¡°ê±´ ë³‘í•© |

---

## 7. í…ŒìŠ¤íŠ¸ ì´ë ¥

| ë‚ ì§œ | í…ŒìŠ¤í„° | ê²°ê³¼ | ë¹„ê³  |
|------|--------|------|------|
| 2026-01-18 | Claude | âœ… PASS | ì•”ì‹œì  ì°¸ì¡° ì¸ì‹ ê°œì„  (is_refinement ê°•ì œ) |
| 2026-01-17 | Claude | âœ… PASS | LLM ê¸°ë°˜ ì˜ë„ íŒë‹¨ ìˆ˜ì • í›„ í†µê³¼ |
| 2026-01-17 | Claude | ğŸ”„ | ì‹œë‚˜ë¦¬ì˜¤ ì‘ì„±, ì´ˆê¸° í…ŒìŠ¤íŠ¸ ì§„í–‰ ì¤‘ |

### 2026-01-18 ì•”ì‹œì  ì°¸ì¡° ì¸ì‹ ê°œì„ 

**ë¬¸ì œ:** "mer_008 ê°€ë§¹ì ë§Œ"ì²˜ëŸ¼ ëª…ì‹œì  í‚¤ì›Œë“œ ì—†ì´ í•„í„° ì¶”ê°€ ìš”ì²­ ì‹œ ì´ì „ WHERE ì¡°ê±´ì´ ìœ ì§€ë˜ì§€ ì•ŠìŒ

**ìˆ˜ì •:** `text_to_sql.py`ì—ì„œ `is_refinement=True`ì¼ ë•Œ í”„ë¡¬í”„íŠ¸ì—ì„œ ì´ì „ ì¡°ê±´ì„ **"í•„ìˆ˜"**ë¡œ ê°•ì¡°

**í…ŒìŠ¤íŠ¸ ê²°ê³¼:**
```
Step 1: "ìµœê·¼ 1ê°œì›” ê²°ì œê±´ ì¡°íšŒ"
  â†’ WHERE created_at >= NOW() - INTERVAL '1 months'

Step 2: "mer_008 ê°€ë§¹ì ë§Œ" (ì•”ì‹œì  ì°¸ì¡°)
  â†’ WHERE created_at >= ... '1 months' AND merchant_id = 'mer_008' âœ…

Step 3: "DONE ìƒíƒœë§Œ" (3ë‹¨ê³„ ì²´ì´ë‹)
  â†’ WHERE ... '1 months' AND merchant_id = 'mer_008' AND status = 'DONE' âœ…
```

**ê´€ë ¨ check-point:** `check-point/016-implicit-reference-recognition-fix.md`

### ì‹¤ì œ í…ŒìŠ¤íŠ¸ ê²°ê³¼ (2026-01-17)

**TC-005-1 ê²°ê³¼:**
| ë‹¨ê³„ | SQL WHERE ì ˆ | ê±´ìˆ˜ | ê²°ê³¼ |
|------|-------------|------|------|
| 1 | `created_at >= NOW() - INTERVAL '3 months'` | 1000 | âœ… |
| 2 | `... AND merchant_id = 'mer_001'` | 125 | âœ… |
| 3 | `... AND order_name LIKE '%ë„ì„œ%'` | 25 | âœ… |
| 4 | `created_at >= NOW() - INTERVAL '1 month'` (ë¦¬ì…‹!) | 684 | âœ… |
| 5 | `'1 month' AND merchant_id = 'mer_008'` (mer_001, ë„ì„œ ì—†ìŒ!) | 88 | âœ… |

**í•µì‹¬ ê²€ì¦:** Step 5ì—ì„œ ì´ì „ ì„¸ì…˜ ì¡°ê±´(mer_001, ë„ì„œ) ì—†ì´ 1 month + mer_008ë§Œ í¬í•¨ë¨

---

## 8. ê´€ë ¨ ì‹œë‚˜ë¦¬ì˜¤

- [003-where-condition-chaining.md](003-where-condition-chaining.md) - WHERE ì¡°ê±´ ëˆ„ì  ê¸°ë³¸ ë™ì‘
