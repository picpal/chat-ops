"""
Reference Patterns Constants

참조 표현 감지를 위한 상수 정의
연속 대화에서 이전 결과 참조, 새 쿼리 판단, 집계 요청 감지에 사용
"""

from enum import Enum
from typing import Dict, List


# ============================================
# 참조 표현 유형 Enum
# ============================================

class ReferenceType(str, Enum):
    """참조 표현 유형"""
    LATEST = "latest"      # 직전 결과 참조 ("이중에", "방금")
    SPECIFIC = "specific"  # 특정 결과 참조 ("30건에서", "첫 번째 결과")
    PARTIAL = "partial"    # 부분 결과 참조 ("상위 10개", "처음 5건")
    NONE = "none"          # 참조 표현 없음


# ============================================
# 참조 표현 패턴 (30개+)
# Phase 3: 암시적 필터 패턴 추가 (4단계+ 체이닝 지원)
# ============================================

REFERENCE_PATTERNS: Dict[ReferenceType, List[str]] = {
    ReferenceType.LATEST: [
        # 한글 - 표준 표현
        r'이\s*중에?서?',        # "이중에", "이 중에서", "이중에서"
        r'여기서',               # "여기서"
        r'그\s*중에?서?',        # "그중에", "그 중에서"
        r'직전\s*(결과|데이터)?', # "직전", "직전 결과"
        r'방금\s*(결과|데이터)?', # "방금", "방금 결과"
        r'위\s*결과',            # "위 결과", "위결과"
        r'앞\s*(서|에서)',        # "앞서", "앞에서"
        r'해당\s*데이터',         # "해당 데이터"
        r'이\s*결과에?서?',       # "이 결과", "이 결과에서"
        r'저\s*중에?서?',         # "저중에", "저 중에서"
        r'거기서',               # "거기서"
        # 한글 - 구어체/줄임말
        r'아까\s*(그\s*)?(거|것|데이터)?', # "아까 그거", "아까 거"
        r'그거에?서?',           # "그거에서", "그거서"
        r'이거에?서?',           # "이거에서", "이거서"
        r'조회\s*한\s*거에?서?',  # "조회한 거에서"
        r'나온\s*(거|것)에?서?',  # "나온 거에서"
        r'보여준\s*(거|것)에?서?', # "보여준 거에서"
        r'받은\s*(거|것|데이터)에?서?', # "받은 거에서"
        r'화면\s*(에\s*)?(있는|보이는)', # "화면에 있는"
        r'지금\s*(보이는|있는)',  # "지금 보이는"
        # 한글 - 상황별 표현
        r'조회된\s*결과',         # "조회된 결과"
        r'이전\s*결과에?서?',     # "이전 결과에서"
        r'검색\s*결과에?서?',     # "검색 결과에서"
        r'목록에?서?',           # "목록에서"
        r'테이블에?서?',         # "테이블에서"
        # 영어/영한 혼용
        r'from\s*(this|these|here)', # "from this", "from these"
        r'among\s*(this|these)',     # "among these"
        r'in\s*this\s*(result|data|list)', # "in this result"
        r'out\s*of\s*(this|these)',  # "out of these"
        r'(this|these)\s*중에?서?',  # "these 중에서"

        # Phase 3: 암시적 필터 패턴 (문장 끝 "~만" 표현)
        # 4단계+ 체이닝에서 "금액 10만원 이상만" 같은 표현 감지
        r'.{2,}(것|건|거|데이터)만\s*$',  # "~것만", "~건만", "~거만" 으로 끝남
        r'.{2,}(인|한|된|는)\s*것만\s*$', # "~인 것만", "~한 것만" 으로 끝남
        r'(금액|amount).{0,15}(이상|이하|초과|미만).{0,5}만', # "금액 X 이상만"
        r'(상태|status).{0,10}(인|가|만)',  # "상태가 X인 것만"
        r'(결제|method).{0,10}(인|가|만)',  # "결제수단이 X인 것만"
        r'(가맹점|merchant).{0,10}(만|것만)', # "가맹점 X만"

        # Phase 3: 암시적 필터 - 비교/범위 표현
        r'(만원|원)\s*(이상|이하|초과|미만)',  # "10만원 이상"
        r'\d+\s*(이상|이하|초과|미만)\s*만?$', # "100 이상만"
        r'(크|작|높|낮|많|적)(은|고)\s*(것|건|거)만',  # "큰 것만", "작은 건만"

        # Phase 3: 필터 추가 표현
        r'추가로\s*.{0,10}(필터|조건)',  # "추가로 필터"
        r'(조건|필터)\s*추가',            # "조건 추가"
        r'더\s*좁혀',                    # "더 좁혀서"
        r'범위\s*좁혀',                  # "범위 좁혀서"
    ],
    ReferenceType.SPECIFIC: [
        # 특정 결과 지정 (숫자 앞에 맥락 필요)
        r'아까\s*\d+건',         # "아까 30건"
        r'(그|저)\s*\d+건에?서?', # "그 30건에서"
        r'(첫|두|세)\s*번째\s*(결과|데이터)', # "첫 번째 결과"
        r'(처음|마지막)\s*(결과|데이터)', # "처음 결과", "마지막 결과"
        r'(이전|앞의?)\s*조회',   # "이전 조회"
        r'결과\s*\d+건에?서?',   # "결과 30건에서"
    ],
    ReferenceType.PARTIAL: [
        # 부분 결과 참조
        r'상위\s*\d+',           # "상위 10개"
        r'하위\s*\d+',           # "하위 5개"
        r'처음\s*\d+건?',        # "처음 5건"
        r'위\s*\d+건?',          # "위 10건"
        r'top\s*\d+',            # "top 10"
        r'first\s*\d+',          # "first 5"
    ]
}


# ============================================
# 새 쿼리 패턴 (이전 조건 무시)
# ============================================

NEW_QUERY_PATTERNS: List[str] = [
    r'새로\s*.{0,10}조회',   # "새로 조회", "새로 환불 내역 조회"
    r'다시\s*.{0,10}조회',   # "다시 조회", "다시 결제 조회"
    r'처음부터',             # "처음부터"
    r'새\s*쿼리',            # "새 쿼리"
    r'전체\s*다시',          # "전체 다시"
    r'전체\s*조회',          # "전체 조회"
    r'새로\s*검색',          # "새로 검색"
    r'다른\s*(데이터|것|거)', # "다른 데이터"
    r'별도로',               # "별도로"
    r'fresh\s*query',        # "fresh query"
    r'new\s*search',         # "new search"
]


# ============================================
# 집계 키워드 패턴 (이전 결과 참조로 처리)
# 이전 대화에서 조회한 결과에 대해 집계하는 것으로 간주
# ============================================

AGGREGATION_KEYWORDS: List[str] = [
    # 한글 집계 표현
    r'합산',                 # "합산해줘"
    r'합계',                 # "합계 보여줘"
    r'총\s*(금액|결제|매출|건수|수량)', # "총 금액", "총 결제", "총 매출"
    r'전체\s*(금액|결제|매출)',  # "전체 금액" (단, "전체 조회"는 제외)
    r'더해',                 # "더해줘"
    r'sum',                  # "sum 구해줘"
    r'평균',                 # "평균 구해줘"
    r'평균\s*(금액|결제|매출)',  # "평균 금액"
    r'avg',                  # "avg 구해줘"
    r'개수',                 # "개수 세줘"
    r'몇\s*건',              # "몇 건이야"
    r'카운트',               # "카운트 해줘"
    r'count',                # "count 해줘"
    r'최대\s*(금액|값)',      # "최대 금액"
    r'최소\s*(금액|값)',      # "최소 금액"
    r'max',                  # "max 구해줘"
    r'min',                  # "min 구해줘"
]


# ============================================
# 산술 연산 요청 패턴 (Text-to-SQL 직접 계산용)
# 이전 집계 결과에 대해 수수료, VAT 등 산술 연산 요청 감지
# ============================================

ARITHMETIC_REQUEST_PATTERNS: List[str] = [
    # 수수료/비율 계산
    r'([\d.]+)\s*%\s*(수수료|fee|비율)',        # "0.6% 수수료"
    r'수수료\s*([\d.]+)\s*%',                   # "수수료 0.6%"
    r'(수수료|fee).*얼마',                       # "수수료 얼마야?"
    r'(수수료|fee|비율)\s*적용',                 # "수수료 적용"
    r'([\d.]+)\s*%\s*는?\s*얼마',               # "0.6%는 얼마"
    r'([\d.]+)\s*(퍼센트|프로)\s*(는|면|이면)?', # "0.6퍼센트면"

    # VAT/세금 계산
    r'(VAT|부가세|세금)\s*([\d.]+)\s*%',         # "VAT 10%"
    r'([\d.]+)\s*%\s*(VAT|부가세|세금)',         # "10% VAT"
    r'(VAT|부가세|세금)\s*(포함|제외|빼|더)',     # "VAT 포함", "부가세 제외"
    r'(VAT|부가세|세금)\s*적용',                  # "VAT 적용"

    # 기본 산술 연산
    r'([\d,]+)\s*(로|으로)\s*(나누|나눠)',        # "1000으로 나눠"
    r'([\d,]+)\s*(배|곱)',                        # "2배", "3곱"
    r'([\d,]+)\s*(를|을)?\s*(더해|빼)',           # "100을 더해"
    r'여기에?\s*([\d.]+)\s*%',                   # "여기에 10%"
    r'거기에?\s*([\d.]+)\s*%',                   # "거기에 5%"

    # 계산 요청 표현
    r'계산\s*해\s*(줘|봐)',                       # "계산해줘"
    r'얼마\s*(야|인가|인지|일까)',                # "얼마야?"
    r'(금액|비용)\s*(은|이)?\s*얼마',             # "금액은 얼마"
]
